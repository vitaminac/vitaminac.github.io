<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="content-language" content="en" />
    <link rel="icon" href="/favicon.ico" />
    <title>DLL Hijacking via zlib DLL Proxy</title>
    <meta name="og:title" content="DLL Hijacking via zlib DLL Proxy" />
    <meta name="author" content="Gao" />
    <meta name="keywords" content="dll injection,dll hijacking,zlib,外挂" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="next-head-count" content="10" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
      integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
      integrity="sha512-c42qTSw/wPZ3/5LBzD+Bw5f7bSF2oxou6wEb+I/lqeaKV5FDIfMvvRp772y4jcJLKuGUOpbJMdg/BTl50fJYAw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.css"
      integrity="sha384-ZPe7yZ91iWxYumsBEOn7ieg8q/o+qh/hQpSaPow8T6BwALcXSCS6C6fSRPIAnTQs"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css"
      integrity="sha512-hasIneQUHlh06VNBe7f6ZcHmeRTLIaQWFd43YriJ0UND19bvYRauxthDg8E4eVNPm9bRUhr5JGeqH7FRFXQu5g=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      rel="preload"
      href="/_next/static/css/02f4e97d1c9ded28.css"
      as="style"
    />
    <link
      rel="stylesheet"
      href="/_next/static/css/02f4e97d1c9ded28.css"
      data-n-g=""
    />
    <noscript data-n-css=""></noscript>
    <script
      defer=""
      nomodule=""
      src="/_next/static/chunks/polyfills-42372ed130431b0a.js"
    ></script>
    <script
      src="/_next/static/chunks/webpack-b8f8d6679aaa5f42.js"
      defer=""
    ></script>
    <script
      src="/_next/static/chunks/framework-49c6cecf1f6d5795.js"
      defer=""
    ></script>
    <script
      src="/_next/static/chunks/main-78a206356629e049.js"
      defer=""
    ></script>
    <script
      src="/_next/static/chunks/pages/_app-06c8ebbaaf0e976b.js"
      defer=""
    ></script>
    <script
      src="/_next/static/chunks/470-88ca63604181d961.js"
      defer=""
    ></script>
    <script
      src="/_next/static/chunks/287-15331c4732f63f37.js"
      defer=""
    ></script>
    <script
      src="/_next/static/chunks/pages/posts/%5Bslug%5D-bde1d94dd5e8ff43.js"
      defer=""
    ></script>
    <script src="/_next/static/fixed/_buildManifest.js" defer=""></script>
    <script src="/_next/static/fixed/_ssgManifest.js" defer=""></script>
  </head>
  <body>
    <div id="__next">
      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
        crossorigin="anonymous"
      />
      <nav
        class="navbar navbar-expand-md navbar-light sticky-top NavigationBar_navBar__fSiIq tw-bg-white/95 tw-shadow tw-shadow-black/25"
      >
        <div class="container-fluid px-md-5">
          <div class="navbar-brand animate__animated animate__pulse">
            <span
              class="tw-rounded tw-bg-black tw-p-1 tw-text-xl tw-font-medium tw-text-white"
              >Gao&#x27;s blog</span
            >
          </div>
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="navbar-collapse collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mb-2 mb-lg-0 ms-auto">
              <li class="nav-item">
                <a
                  class="nav-link active"
                  aria-current="page"
                  href="/posts/langs/en/pagination/1/"
                  >Home</a
                >
              </li>
              <li class="nav-item">
                <a
                  class="nav-link"
                  aria-current="page"
                  href="/posts/langs/en/tags/"
                  >Tags</a
                >
              </li>
              <li class="nav-item dropdown">
                <a
                  class="nav-link dropdown-toggle"
                  href="#"
                  role="button"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                  >Language</a
                >
                <ul class="dropdown-menu dropdown-menu-end">
                  <li>
                    <a class="dropdown-item" href="/posts/langs/en/">English</a>
                  </li>
                  <li>
                    <a class="dropdown-item" href="/posts/langs/es/">Spanish</a>
                  </li>
                  <li>
                    <a class="dropdown-item" href="/posts/langs/zh/">Chinese</a>
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
      </nav>
      <header
        class="tw-flex tw-h-96 tw-w-screen tw-flex-col tw-content-center tw-justify-center tw-bg-cover tw-bg-center tw-bg-no-repeat tw-text-center tw-text-white"
        style="
          background-image: url(/_next/static/media/default-post-preview.c96b099a.jpeg);
        "
      >
        <h1>DLL Hijacking via zlib DLL Proxy</h1>
        <p>Author: Gao</p>
        <span
          ><i class="fa-regular fa-calendar"></i
          ><time class="tw-pl-1.5" datetime="2024-07-21 11:59:24"
            >July 21, 2024</time
          ></span
        >
        <section class="tw-mt-3 tw-text-center">
          <p>Tags<!-- -->:</p>
          <ul class="tw-p-0">
            <li class="tw-inline tw-px-1">
              <a
                class="tw-m-0.5 tw-inline-block tw-rounded tw-border tw-border-solid tw-border-white tw-bg-neutral-300 tw-px-2 tw-text-sm tw-leading-6 tw-text-white tw-no-underline hover:tw-bg-sky-300"
                href="/posts/langs/en/tags/dll%20injection/"
                >dll injection</a
              >
            </li>
            <li class="tw-inline tw-px-1">
              <a
                class="tw-m-0.5 tw-inline-block tw-rounded tw-border tw-border-solid tw-border-white tw-bg-neutral-300 tw-px-2 tw-text-sm tw-leading-6 tw-text-white tw-no-underline hover:tw-bg-sky-300"
                href="/posts/langs/en/tags/dll%20hijacking/"
                >dll hijacking</a
              >
            </li>
            <li class="tw-inline tw-px-1">
              <a
                class="tw-m-0.5 tw-inline-block tw-rounded tw-border tw-border-solid tw-border-white tw-bg-neutral-300 tw-px-2 tw-text-sm tw-leading-6 tw-text-white tw-no-underline hover:tw-bg-sky-300"
                href="/posts/langs/en/tags/zlib/"
                >zlib</a
              >
            </li>
            <li class="tw-inline tw-px-1">
              <a
                class="tw-m-0.5 tw-inline-block tw-rounded tw-border tw-border-solid tw-border-white tw-bg-neutral-300 tw-px-2 tw-text-sm tw-leading-6 tw-text-white tw-no-underline hover:tw-bg-sky-300"
                href="/posts/langs/en/tags/%E5%A4%96%E6%8C%82/"
                >外挂</a
              >
            </li>
          </ul>
        </section>
      </header>
      <div class="tw-mx-auto tw-w-11/12">
        <main>
          <article>
            <iframe
              title="dll-hijacking-via-zlib-dll-proxy"
              src="/dll-hijacking-via-zlib-dll-proxy/index.html"
              width="100%"
              height="0px"
            ></iframe>
          </article>
        </main>
        <aside></aside>
      </div>
      <footer class="tw-text-center tw-text-gray-400">
        <div class="row justify-content-center">
          <ul class="list-inline text-center tw-text-stone-700">
            <li class="list-inline-item">
              <a
                class="tw-text-stone-700"
                target="_blank"
                href="https://www.linkedin.com/in/shuxig"
                ><span class="fa-stack fa-lg"
                  ><i class="fa fa-circle fa-stack-2x"></i
                  ><i
                    class="fab fa-linkedin-in fa-stack-1x fa-inverse"
                  ></i></span
              ></a>
            </li>
            <li class="list-inline-item">
              <a
                class="tw-text-stone-700"
                target="_blank"
                href="mailto:dalao1002@gmail.com?subject=From my blog&amp;body=Hi,I found this website very useful"
                ><span class="fa-stack fa-lg"
                  ><i class="fa fa-circle fa-stack-2x"></i
                  ><i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span
              ></a>
            </li>
            <li class="list-inline-item">
              <a
                class="tw-text-stone-700"
                target="_blank"
                href="https://github.com/vitaminac"
                ><span class="fa-stack fa-lg"
                  ><i class="fa fa-circle fa-stack-2x"></i
                  ><i class="fab fa-github fa-stack-1x fa-inverse"></i></span
              ></a>
            </li>
            <li class="list-inline-item">
              <a
                class="tw-text-stone-700"
                target="_blank"
                href="https://gist.github.com/vitaminac"
                ><span class="fa-stack fa-lg"
                  ><i class="fa fa-circle fa-stack-2x"></i
                  ><i
                    class="fab fa-github-square fa-stack-1x fa-inverse"
                  ></i></span
              ></a>
            </li>
            <li class="list-inline-item">
              <a
                class="tw-text-stone-700"
                target="_blank"
                href="https://gitlab.com/vitaminac"
                ><span class="fa-stack fa-lg"
                  ><i class="fa fa-circle fa-stack-2x"></i
                  ><i class="fab fa-gitlab fa-stack-1x fa-inverse"></i></span
              ></a>
            </li>
            <li class="list-inline-item">
              <a
                class="tw-text-stone-700"
                target="_blank"
                href="https://www.kaggle.com/dalao1002"
                ><span class="fa-stack fa-lg"
                  ><i class="fa fa-circle fa-stack-2x"></i
                  ><i class="fab fa-kaggle fa-stack-1x fa-inverse"></i></span
              ></a>
            </li>
            <li class="list-inline-item">
              <a
                class="tw-text-stone-700"
                target="_blank"
                href="https://leetcode.com/dalao1002"
                ><span class="fa-stack fa-lg"
                  ><i class="fa fa-circle fa-stack-2x"></i
                  ><i class="fas fa-code fa-stack-1x fa-inverse"></i></span
              ></a>
            </li>
            <li class="list-inline-item">
              <a
                class="tw-text-stone-700"
                target="_blank"
                href="https://stackoverflow.com/users/9980245"
                ><span class="fa-stack fa-lg"
                  ><i class="fa fa-circle fa-stack-2x"></i
                  ><i
                    class="fab fa-stack-overflow fa-stack-1x fa-inverse"
                  ></i></span
              ></a>
            </li>
          </ul>
        </div>
        <img
          alt="QR"
          loading="lazy"
          width="1710"
          height="624"
          decoding="async"
          data-nimg="1"
          class="tw-mx-auto tw-max-w-full tw-object-contain tw-object-center lg:tw-max-w-xl"
          style="
            color: transparent;
            background-size: cover;
            background-position: 50% 50%;
            background-repeat: no-repeat;
            background-image: url(&quot;data:image/svg+xml;charset=utf-8,%3Csvg xmlns=&#x27;http://www.w3.org/2000/svg&#x27; viewBox=&#x27;0 0 320 120&#x27;%3E%3Cfilter id=&#x27;b&#x27; color-interpolation-filters=&#x27;sRGB&#x27;%3E%3CfeGaussianBlur stdDeviation=&#x27;20&#x27;/%3E%3CfeColorMatrix values=&#x27;1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 100 -1&#x27; result=&#x27;s&#x27;/%3E%3CfeFlood x=&#x27;0&#x27; y=&#x27;0&#x27; width=&#x27;100%25&#x27; height=&#x27;100%25&#x27;/%3E%3CfeComposite operator=&#x27;out&#x27; in=&#x27;s&#x27;/%3E%3CfeComposite in2=&#x27;SourceGraphic&#x27;/%3E%3CfeGaussianBlur stdDeviation=&#x27;20&#x27;/%3E%3C/filter%3E%3Cimage width=&#x27;100%25&#x27; height=&#x27;100%25&#x27; x=&#x27;0&#x27; y=&#x27;0&#x27; preserveAspectRatio=&#x27;none&#x27; style=&#x27;filter: url(%23b);&#x27; href=&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAADCAIAAAAhqtkfAAAAVklEQVR42gFLALT/AKrStMHRxZXRpW3NilHIekDGcw/CYyjCZwC/z8LTwcan0LKu37rI48+228C838WZ16oApdSxvdPCi86doNmvx+LNu9vDx+LOn9muCIkyTVum2sgAAAAASUVORK5CYII=&#x27;/%3E%3C/svg%3E&quot;);
          "
          src="/_next/static/media/QR.b48259ea.png"
        />
        <p>Copyright © Gao&#x27;s blog 2024</p>
      </footer>
    </div>
    <script id="__NEXT_DATA__" type="application/json">
      {
        "props": {
          "pageProps": {
            "postData": {
              "title": "DLL Hijacking via zlib DLL Proxy",
              "markdownContentSource": "\nDLL hijacking involves manipulating a program to load a DLL that contains the desired code. We will use a simple technique here for ilustration: DLL replacement. We will build a DLL that perserve the same functionlity and interface of original DLL. So we can swap the original DLL with a the one built by us that contains additional code.\n\nAssuming the vulnerable program has dependency on `zlib1.dll`, which is the open source library. We can first check the version from file properties and download the corresponding version of source code for example [zlib v1.2.1](https://github.com/madler/zlib/tree/v1.2.1).\n\nExecute `cd` into source source folder and then execute `nmake -f win32/Makefile.msc`, we will obtain [zlib.lib](/downloads/code/dll-hijacking/zlib.lib), [zlib1.res](/downloads/code/dll-hijacking/zlib1.res). We can now build our `zlib1.dll`. Put our source code [zlib1.c](/downloads/code/dll-hijacking/zlib1.c) with additional instantiation logic and copy `zlib.lib`, `zlib1.res`, [zlib.def](https://github.com/madler/zlib/blob/v1.2.1/win32/zlib.def) into the same folder and then execute following commands\n\n    cl /c /nologo /O2 /MD /utf-8 zlib1.c\n    link /NOLOGO /RELEASE /DEF:zlib.def /DLL /IMPLIB:zdll.lib /OUT:zlib1.dll zlib1.obj zlib.lib zlib1.res User32.lib Gdi32.lib\n\nIn case we don't have module-definition or `.def` file then we will need to modify the source code of our proxy DLL `zlib1.c`. We need to first execute `dumpbin /EXPORTS zlib1.dll` so we will obtain the export table of original `zlib1.dll`. The output should be something similar to following:\n\n          1    0 00001000 adler32\n          2    1 000011E0 compress\n          3    2 00001130 compress2\n          4    3 00001200 compressBound\n          5    4 00001510 crc32\n          6    5 00001760 deflate\n          7    6 00001680 deflateBound\n          8    7 00001C60 deflateCopy\n          9    8 00001BA0 deflateEnd\n         10    9 00003050 deflateInit2_\n         11    A 00003280 deflateInit_\n         12    B 00002CC0 deflateParams\n         13    C 00001640 deflatePrime\n         14    D 00002C20 deflateReset\n         15    E 00001530 deflateSetDictionary\n         16    F 00001220 get_crc_table\n         17   10 00003B20 gzclearerr\n         18   11 000039D0 gzclose\n         19   12 00003DC0 gzdopen\n         20   13 00003930 gzeof\n         21   14 00003A20 gzerror\n         22   15 00003880 gzflush\n         23   16 000040B0 gzgetc\n         24   17 000040E0 gzgets\n         25   18 00003DA0 gzopen\n         26   19 000036C0 gzprintf\n         27   1A 00003740 gzputc\n         28   1B 00003770 gzputs\n         29   1C 00003E00 gzread\n         30   1D 000038C0 gzrewind\n         31   1E 00004140 gzseek\n         32   1F 000032B0 gzsetparams\n         33   20 000042E0 gztell\n         34   21 000035A0 gzungetc\n         35   22 000035F0 gzwrite\n         36   23 00005950 inflate\n         37   24 000043C0 inflateBack\n         38   25 00005240 inflateBackEnd\n         39   26 00004300 inflateBackInit_\n         40   27 00007060 inflateCopy\n         41   28 00006DB0 inflateEnd\n         42   29 00005740 inflateInit2_\n         43   2A 00005810 inflateInit_\n         44   2B 000056F0 inflateReset\n         45   2C 00006E00 inflateSetDictionary\n         46   2D 00006F30 inflateSync\n         47   2E 00007030 inflateSyncPoint\n         48   2F 00009050 uncompress\n         49   30 00009120 zError\n         50   31 00009110 zlibCompileFlags\n         51   32 00009100 zlibVersion\n\nfor every export attribute we will need a add a line to our `zlib1.c`\n\n    #pragma comment(linker, \"/export:_\u003cexport attribute\u003e\")\n\nfor example\n\n    #pragma comment(linker, \"/export:_zlibVersion\")\n\nWe place generated `zlib1.dll` into program directory and replace the original one, our logic will be executed when program try to load `zlib1.dll`.\n\nAlternatively for any other DLL even it is not open source, we can build a proxy DLL that redirect all the calls to original DLL file. There are automatic tool for generating the proxy DLL.\n\n### Reference\n\n* [API Interception via DLL Redirection](https://www.exploit-db.com/docs/english/13140-api-interception-via-dll-redirection.pdf)\n* [HackTricks: Dll Hijacking](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/dll-hijacking#dll-proxifying)\n* [Can we export a function made available through a static library](https://stackoverflow.com/a/45744068/9980245)\n* [creating dll with cl and linker](https://social.msdn.microsoft.com/Forums/vstudio/en-US/840b6359-c3aa-44b8-b3ef-50e3556e6430/creating-dll-with-cl-and-linker?forum=vclanguage)\n* [/MD, /MT, /LD (Use Run-Time Library)](https://docs.microsoft.com/en-us/cpp/build/reference/md-mt-ld-use-run-time-library?view=msvc-170)\n* [Compiler options listed alphabetically](https://docs.microsoft.com/en-us/cpp/build/reference/compiler-options-listed-alphabetically?view=msvc-170)\n* [Exporting from a DLL Using DEF Files](https://learn.microsoft.com/en-us/cpp/build/exporting-from-a-dll-using-def-files)\n* [/DEF (Specify Module-Definition File)](https://docs.microsoft.com/en-us/cpp/build/reference/def-specify-module-definition-file?view=msvc-170)\n* [c++ creating a window from a dll](https://sim0n.wordpress.com/2009/03/29/c-creating-a-window-from-a-dll/)\n* [Create your Proxy DLLs automatically](https://www.codeproject.com/Articles/16541/Create-your-Proxy-DLLs-automatically)\n* [ProxiFy - Automatic Proxy DLL Generation](https://www.codeproject.com/Articles/1179147/ProxiFy-Automatic-Proxy-DLL-Generation)\n* [SharpDllProxy](https://github.com/Flangvik/SharpDllProxy)\n* [DLL代理转发](https://www.cnblogs.com/hetianlab/p/14031412.html)",
              "slug": "dll-hijacking-via-zlib-dll-proxy",
              "date": "2024-07-21 11:59:24",
              "lang": "en",
              "tags": ["dll injection", "dll hijacking", "zlib", "外挂"],
              "path": "/dll-hijacking-via-zlib-dll-proxy/index.html"
            },
            "lang": "en",
            "_nextI18Next": {
              "initialI18nStore": {
                "en": {
                  "navbar": {
                    "Home": "Home",
                    "Language": "Language",
                    "Tags": "Tags",
                    "en": "English",
                    "es": "Spanish",
                    "zh": "Chinese"
                  },
                  "post-layout": {
                    "Author": "Author: {{author}}",
                    "Tags": "Tags"
                  }
                }
              },
              "initialLocale": "en",
              "ns": ["navbar", "post-layout"],
              "userConfig": {
                "i18n": {
                  "defaultLocale": "en",
                  "locales": ["en", "es", "zh"]
                },
                "default": {
                  "i18n": {
                    "defaultLocale": "en",
                    "locales": ["en", "es", "zh"]
                  }
                }
              }
            }
          },
          "__N_SSG": true
        },
        "page": "/posts/[slug]",
        "query": { "slug": "dll-hijacking-via-zlib-dll-proxy" },
        "buildId": "fixed",
        "isFallback": false,
        "gsp": true,
        "scriptLoader": []
      }
    </script>
  </body>
</html>
